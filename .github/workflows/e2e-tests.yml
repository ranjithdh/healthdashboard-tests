name: E2E Tests - Playwright + Kotlin

on:
  push:
    branches: [main, develop, website_test]
  pull_request:
    branches: [main]
  schedule:
    # Run daily at 2 AM UTC
    - cron: '0 2 * * *'
  workflow_dispatch:
    inputs:
      test_tags:
        description: 'Test tags to run (e.g., Mobile, Desktop)'
        required: false
        default: ''

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

env:
  BASE_URL: https://app.stg.deepholistics.com/
  HEADLESS: true

jobs:
  # Mobile-only tests
  test-mobile:
    name: Mobile Tests
    runs-on: ubuntu-22.04
    if: github.event_name != 'workflow_dispatch' || github.event.inputs.test_tags == 'Mobile'

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          java-version: '17'
          distribution: 'temurin'
          cache: 'gradle'

      - name: Install Playwright browsers
        run: npx playwright@1.44.0 install --with-deps chromium webkit

      - name: Run mobile tests
        run: ./gradlew mobileTests
        env:
          TEST_USER_MOBILE: ${{ secrets.TEST_USER_MOBILE }}
          TEST_USER_OTP: ${{ secrets.TEST_USER_OTP }}

      - name: Generate Allure report
        if: always()
        run: ./gradlew allure3Report -Penvironment=Mobile

      - name: Upload results
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: mobile-test-results
          path: |
            build/reports/tests/
            build/allure-report-v3/
            build/screenshots/
          retention-days: 30

  # Website-only tests
  test-website:
    name: Website Tests
    runs-on: ubuntu-22.04
    if: github.event_name != 'workflow_dispatch' || github.event.inputs.test_tags == 'Website'

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          java-version: '17'
          distribution: 'temurin'
          cache: 'gradle'

      - name: Install Playwright browsers
        run: npx playwright@1.44.0 install --with-deps chromium

      - name: Run website tests
        run: ./gradlew websiteTests

      - name: Generate Allure report
        if: always()
        run: ./gradlew allure3Report -Penvironment=Website

      - name: Upload results
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: website-test-results
          path: |
            build/reports/tests/
            build/allure-report-v3/
            build/screenshots/
          retention-days: 30

  # App-only tests (Login, Profile, etc.)
  test-app:
    name: App Tests
    runs-on: ubuntu-22.04
    if: github.event_name != 'workflow_dispatch' || github.event.inputs.test_tags == 'App'

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          java-version: '17'
          distribution: 'temurin'
          cache: 'gradle'

      - name: Install Playwright browsers
        run: npx playwright@1.44.0 install --with-deps chromium firefox

      - name: Run app tests
        run: ./gradlew appTests
        env:
          TEST_USER_MOBILE: ${{ secrets.TEST_USER_MOBILE }}
          TEST_USER_OTP: ${{ secrets.TEST_USER_OTP }}

      - name: Generate Allure report
        if: always()
        run: ./gradlew allure3Report -Penvironment=App

      - name: Upload results
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: app-test-results
          path: |
            build/reports/tests/
            build/allure-report-v3/
            build/screenshots/
          retention-days: 30

#  # Cross-browser tests
#  test-cross-browser:
#    name: Cross-Browser Tests
#    runs-on: ubuntu-22.04
#    strategy:
#      fail-fast: false
#      matrix:
#        browser: [chromium, firefox, webkit]
#
#    steps:
#      - name: Checkout code
#        uses: actions/checkout@v4
#
#      - name: Set up JDK 17
#        uses: actions/setup-java@v4
#        with:
#          java-version: '17'
#          distribution: 'temurin'
#          cache: 'gradle'
#
#      - name: Install Playwright browser (${{ matrix.browser }})
#        run: npx playwright@1.44.0 install --with-deps ${{ matrix.browser }}
#
#      - name: Run tests on ${{ matrix.browser }}
#        run: ./gradlew test -Dbrowser=${{ matrix.browser }}
#        env:
#          TEST_USER_MOBILE: ${{ secrets.TEST_USER_MOBILE }}
#          TEST_USER_OTP: ${{ secrets.TEST_USER_OTP }}
#
#      - name: Upload results
#        uses: actions/upload-artifact@v4
#        if: always()
#        with:
#          name: ${{ matrix.browser }}-test-results
#          path: |
#            build/reports/tests/
#            build/screenshots/
#          retention-days: 30
